#!/bin/bash

set -ex

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

. $SCRIPT_DIR/common.sh

dockerfile=$SCRIPT_DIR/.Dockerfile.signalfx-agent-dev

cat $SCRIPT_DIR/../Dockerfile > $dockerfile

cat <<-'EOH' >> $dockerfile

FROM ubuntu:16.04 as dev-extras

RUN apt update &&\
    apt install -y libcurl4-openssl-dev &&\
    apt install -y \
      autoconf \
      automake \
      autotools-dev \
      bison \
      build-essential \
      flex \
      git \
      inotify-tools \
      libtool \
      pkg-config \
      python-pip

RUN pip install ipython==5 ipdb

COPY scripts/collect-libs /opt/collect-libs
# Collect all of the collectd and agent build tools
RUN /opt/collect-libs /opt/deps \
      /usr/bin/aclocal \
      /usr/bin/as \
      /usr/bin/autoconf \
      /usr/bin/autoheader \
      /usr/bin/automake \
      /usr/bin/basename \
      /usr/bin/bison \
      /usr/bin/dirname \
      /usr/bin/find \
      /usr/bin/g++ \
      /usr/bin/gcc \
      /usr/bin/git \
      /usr/bin/inotifywait \
      /usr/bin/ld \
      /usr/bin/lex \
      /usr/bin/libtoolize \
      /usr/bin/make \
      /usr/bin/perl \
      /usr/bin/pkg-config \
      /usr/bin/xargs \
      /usr/local/bin/ipdb \
      /usr/local/bin/ipython &&\
    cp -R --parents -a /usr/lib/ /usr/include /usr/share /opt/deps

FROM final-image

WORKDIR /go/src/github.com/signalfx/neo-agent
CMD ["/bin/bash"]
ENV PATH=$PATH:/usr/local/go/bin:/go/bin GOPATH=/go

COPY --from=agent-builder /usr/local/go/ /usr/local/go
COPY --from=godeps /usr/bin/dep /usr/bin/dep

COPY --from=dev-extras /usr/local/lib/python2.7/ /usr/local/lib/python2.7

COPY --from=collectd /usr/src/collectd/ /usr/src/collectd

COPY --from=dev-extras /opt/deps/ /

RUN mkdir /tmp && go get -u github.com/golang/lint/golint
RUN go get github.com/derekparker/delve/cmd/dlv

COPY --from=godeps /go/src/github.com/signalfx/neo-agent/vendor src/github.com/signalfx/neo-agent/vendor
COPY --from=godeps /go/pkg /go/pkg

EOH

do_docker_build signalfx-agent-dev $dockerfile
